"use strict";WPForms.Admin.Builder.Providers.Mailchimp=WPForms.Admin.Builder.Providers.Mailchimp||function(e,n,s){var d={$providerHolder:null,$providerConnections:null,$lock:null,$error:null,config:{templates:["wpforms-mailchimpv3-builder-content-connection","wpforms-mailchimpv3-builder-content-connection-data","wpforms-mailchimpv3-builder-content-connection-subscribe","wpforms-mailchimpv3-builder-content-connection-unsubscribe","wpforms-mailchimpv3-builder-content-connection-archive","wpforms-mailchimpv3-builder-content-connection-delete","wpforms-mailchimpv3-builder-content-connection-record-event","wpforms-mailchimpv3-builder-content-connection-required-fields","wpforms-mailchimpv3-builder-content-connection-error","wpforms-mailchimpv3-builder-content-connection-lock","wpforms-mailchimpv3-builder-content-connection-conditionals"]},replaceConnectionIds:function(i,e){e.find("input, textarea, select, label, .wpforms-panel-field-select").each(function(){var e=s(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,i)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,i)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,i)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,i))})},connectionAccountExists:function(e,i){return!_.isEmpty(i)&&(!!_.isEmpty(e)||_.has(i,e))}},l={provider:"mailchimpv3",Providers:{},Templates:{},Cache:{},isReady:!1,init:function(){"providers"===wpf.getQueryString("view")&&s("#wpforms-panel-providers").on("WPForms.Admin.Builder.Providers.ready",l.ready),s(e).on("wpformsPanelSwitched",function(e,i){"providers"===i&&l.ready()})},ready:function(){l.isReady||(l.Providers=WPForms.Admin.Builder.Providers,l.Templates=WPForms.Admin.Builder.Templates,l.Cache=l.Providers.cache,d.$providerHolder=l.Providers.getProviderHolder(l.provider),d.$providerConnections=d.$providerHolder.find(".wpforms-builder-provider-connections"),l.Templates.add(d.config.templates),l.Providers.ui.account.registerAddHandler(l.provider,l.processAccountAdd),l.bindUIActions(),l.bindTriggers(),l.processInitial(),l.isReady=!0)},bindUIActions:function(){d.$providerHolder.on("connectionCreate",l.connection.callbacks.create).on("connectionDelete",l.connection.callbacks.delete).on("change",".js-wpforms-builder-mailchimp-provider-connection-account",l.ui.account.changeCallback).on("change",".js-wpforms-builder-mailchimp-provider-connection-lists",l.ui.list.changeCallback).on("change",".js-wpforms-builder-mailchimp-provider-connection-action",l.ui.action.changeCallback).on("change",".js-wpforms-builder-mailchimp-provider-update-profile",l.ui.updateProfile.changeCallback)},bindTriggers:function(){d.$providerConnections.on("connectionsDataLoaded",l.triggers.connectionsDataLoadedHandler).on("connectionGenerated",l.triggers.connectionGeneratedHandler).on("connectionGeneralSettingsRendered",l.triggers.connectionGeneralSettingsRenderedHandler).on("connectionRendered",l.triggers.connectionRenderedHandler),s("#wpforms-builder").on("wpformsSaved",l.requireGDPR.init).on("wpformsFieldDelete",l.triggers.wpformsFieldDeleteHandler),s("#wpforms-field-options").on("change",".wpforms-field-option-name .wpforms-field-option-row-format select",l.triggers.registerTriggerOnNameFormatChange),l.Providers.panelHolder.on("WPForms.Admin.Builder.Providers.updatedMapSelects",l.triggers.updatedMapSelectsHandler)},processInitial:function(){d.$providerConnections.prepend(l.tmpl.callbacks.commonsHTML()),d.$lock=d.$providerConnections.find(".wpforms-builder-provider-connections-save-lock"),d.$error=d.$providerConnections.find(".wpforms-builder-provider-connections-error"),l.connection.callbacks.dataLoad()},processAccountAdd:function(i){var e,n,o;return i.$$add.prop("disabled")||(e=i.$content.find('input[name="apikey"]'),n=i.$content.find(".error"),o=s.trim(e.val()),i.$$add.prop("disabled",!0),_.isEmpty(o)?(n.show(),i.setType("red"),e.addClass("wpforms-error"),i.$$add.prop("disabled",!1)):(n.hide(),i.setType("blue"),e.removeClass("wpforms-error"),l.Providers.ajax.request(l.provider,{data:{task:"account_save",apikey:o,label:s.trim(i.$content.find('input[name="label"]').val())}}).done(function(e){!e.success||_.has(e.data,"error")&&!_.isEmpty(e.data.error)?(i.setType("red"),i.$$add.prop("disabled",!1),n.html(e.data.error).show()):(d.$providerHolder.find(".wpforms-builder-provider-title-add").toggleClass("hidden"),i.close())}))),!1},mapFields:function(e,i){var n=l.Cache.getById(l.provider,"connections",e);_.isEmpty(n)||_.isEmpty(n.fields)||""!==n.fields.EMAIL&&s('select[name="providers['+l.provider+"]["+e+'][fields][EMAIL]"]',i).val(n.fields.EMAIL)},loadChoicesJS:function(e){_.isFunction(n.Choices)&&(e=s(".choicesjs-select",e)).length&&e.each(function(){var e=s(this);_.isUndefined(e.data("choicesjs"))&&e.data("choicesjs",new Choices(this,{shouldSort:!1,removeItemButton:!0,callbackOnInit:function(){wpf.initMultipleSelectWithSearch(this)}}))})},connection:{getById:function(e){return d.$providerConnections.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},filterFieldsMeta:function(e,i){var n,o;return!_.isEmpty(e.fields_meta)&&_.isEmpty(e.fields_reqs)&&(n=[],o=[],_.each(e.fields_meta,function(e){_.has(e,"name")&&(_.has(i.required,e.name)?o:n).push(e)}),e.fields_meta=n,e.fields_reqs=o),e},callbacks:{create:function(e,i){var n=(new Date).getTime().toString(16),i={isNew:!0,id:n,connection_name:i};l.Cache.addTo(l.provider,"connections",n,i),l.connection.callbacks.generate({connection:i})},delete:function(e,i){i.closest(d.$providerHolder).length&&(i=i.data("connection_id"),_.isUndefined(typeof i)||l.Cache.deleteFrom(l.provider,"connections",i))},generate:function(i){var e=l.Cache.get(l.provider,"accounts");_.isEmpty(e)?l.Providers.ajax.request(l.provider,{data:{task:"accounts_get"}}).done(function(e){e.success&&_.has(e.data,"accounts")?(l.Cache.set(l.provider,"accounts",e.data.accounts),l.connection.callbacks.render(i,e.data.accounts)):l.helpers.showErrorMsg(e.data)}):l.connection.callbacks.render(i,e)},render:function(e,i){var n=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection");d.connectionAccountExists(e.connection.account_id,i)&&(d.$providerConnections.prepend(n({accounts:i,connection:e.connection,provider:l.provider,form_id:l.Providers.form.data("id")})),d.$providerConnections.trigger("connectionGenerated",[e]))},dataLoad:function(){l.Providers.ajax.request(l.provider,{data:{task:"connections_get"}}).done(function(e){e.success&&_.has(e.data,"connections")?(l.Cache.set(l.provider,"connections",jQuery.extend({},e.data.connections)),l.Cache.set(l.provider,"conditionals",jQuery.extend({},e.data.conditionals)),_.isEmpty(e.data.accounts)||l.Cache.set(l.provider,"accounts",jQuery.extend({},e.data.accounts)),d.$providerConnections.trigger("connectionsDataLoaded",[e.data])):l.helpers.showErrorMsg(e.data)})}}},ui:{account:{changeCallback:function(){var e=s(this),i=e.val(),n=e.closest(".wpforms-builder-provider-connection"),o=n.data("connection_id"),r=l.Cache.get(l.provider,"lists");s(".wpforms-builder-mailchimp-provider-connection-data",n).empty(),""===i?e.addClass("wpforms-error"):(e.removeClass("wpforms-error"),_.isEmpty(r)||!_.has(r,i)?l.ui.account.request({account_id:i,connection_id:o}):l.ui.account.render({account_id:i,connection_id:o}))},request:function(i){l.Providers.ajax.request(l.provider,{data:{task:"objects_get",account_id:i.account_id,connection_id:i.connection_id,sources:{lists:!0}}}).done(function(e){!e.success||_.isEmpty(e.data)?l.helpers.showErrorMsg(e.data):(_.isUndefined(l.Cache.get(l.provider,"lists"))&&l.Cache.set(l.provider,"lists",{}),l.Cache.addTo(l.provider,"lists",i.account_id,e.data.lists),l.ui.account.render(i))})},render:function(e){var i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-data"),n=s("#tmpl-wpforms-"+l.provider+"-builder-content-connection-conditionals").length?l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-conditionals"):l.Templates.get("wpforms-providers-builder-content-connection-conditionals"),o=l.connection.getById(e.connection_id),r=l.Cache.getById(l.provider,"connections",e.connection_id),t=l.Cache.getById(l.provider,"lists",e.account_id),n=_.has(r,"isNew")&&r.isNew?n():l.Cache.getById(l.provider,"conditionals",e.connection_id);r.account_id===e.account_id&&!_.isEmpty(t)||(r={id:r.id}),o.find(".wpforms-builder-mailchimp-provider-connection-data").html(i({lists:l.Cache.getById(l.provider,"lists",e.account_id),connection:r,conditional:n,provider:l.provider})),d.$providerConnections.trigger("connectionGeneralSettingsRendered",[l.provider,e.connection_id])}},list:{changeCallback:function(){var e=s(this),i=e.closest(".wpforms-builder-provider-connection").find(".js-wpforms-builder-mailchimp-provider-connection-action");""===e.val()&&i.prop("selectedIndex",0).trigger("change")}},action:{changeCallback:function(){var e=s(this),i=e.closest(".wpforms-builder-provider-connection"),n=i.data("connection_id"),o=i.find(".js-wpforms-builder-mailchimp-provider-connection-account"),r=i.find(".js-wpforms-builder-mailchimp-provider-connection-lists"),t=e.val();s(".wpforms-builder-mailchimp-provider-actions-data",i).empty(),""===r.val()?r.addClass("wpforms-error"):(e.removeClass("wpforms-error"),r.removeClass("wpforms-error"),l.actions.init({action:t,target:e,list_id:r.val(),account_id:o.val(),connection_id:n}))}},updateProfile:{changeCallback:function(){var e=s(this),i=e.closest(".wpforms-builder-provider-connection").find(".js-wpforms-builder-mailchimp-provider-notify-user");i.closest(".wpforms-builder-provider-connection-setting").toggleClass("wpforms-hidden",e.prop("checked")),e.prop("checked")&&i.prop("checked",!1)}}},triggers:{connectionsDataLoadedHandler:function(e,i){_.each(i.connections,function(e,i){_.isEmpty(e)||l.connection.callbacks.generate({connection:e,conditional:l.Cache.getById(l.provider,"conditionals",i)})})},connectionGeneratedHandler:function(e,i){i=l.connection.getById(i.connection.id),i=s(".js-wpforms-builder-mailchimp-provider-connection-account",i);""!==i.val()&&i.trigger("change")},connectionGeneralSettingsRenderedHandler:function(e,i,n){var o=l.connection.getById(n),r=s(".js-wpforms-builder-mailchimp-provider-connection-action",o);d.replaceConnectionIds(n,o),""!==r.val()&&r.trigger("change")},connectionRenderedHandler:function(e,i,n){var o=l.connection.getById(n);d.replaceConnectionIds(n,o),l.mapFields(n,o),l.loadChoicesJS(o)},updatedMapSelectsHandler:function(e,i,n,o){i=i.filter(".wpforms-builder-mailchimp-provider-connection");_.isEmpty(i)||(l.helpers.updateMapSelects(i,n),o)||l.helpers.maybeSaveFormState()},wpformsFieldDeleteHandler:function(e,i,n){_.isString(n)&&"name"===n&&(n=s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value^="'+i+'."]',d.$providerConnections)).length&&n.remove()},registerTriggerOnNameFormatChange:function(e){var i=d.$providerConnections.find(".wpforms-builder-provider-connection");i.length&&l.Providers.panelHolder.trigger("WPForms.Admin.Builder.Providers.updatedMapSelects",[i,wpf.getFields(),!0])}},requireGDPR:{hasErrors:!1,isNotified:!1,init:function(){var e=d.$providerConnections.find(".wpforms-builder-provider-connection"),i=s("#wpforms-panel-fields").find(".wpforms-field-gdpr-checkbox");e.length&&!i.length&&(l.requireGDPR.isNotified=!1,e.each(l.requireGDPR.check))},check:function(){var e,i=s(this),n=s(".js-wpforms-builder-mailchimp-provider-connection-action",i),o=s(".js-wpforms-builder-mailchimp-provider-connection-lists",i);return!(n.length&&o.length&&"subscribe"===n.val()&&(e=o.find("option:selected")).data("marketing_permissions")&&(l.requireGDPR.hasErrors=!0,setTimeout(function(){l.requireGDPR.notify({connectionName:i.find(".wpforms-builder-provider-connection-name").val(),listName:e.text().trim()})},100),1))},notify:function(e){var i;_.has(n,"jconfirm")&&!_.isEmpty(n.jconfirm.instances)||l.requireGDPR.hasErrors&&!l.requireGDPR.isNotified&&(i=(i=(i=wpformsMailchimpBuilderVars.i18n.gdpr).replace("{audience}",e.listName)).replace("{connection}",e.connectionName),s.alert({title:wpforms_builder.heads_up,content:i,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}),l.requireGDPR.isNotified=!0)}},actions:{init:function(e){switch(e.action){case"subscribe":l.actions.subscribe.init(e);break;case"unsubscribe":l.actions.unsubscribe.init(e);break;case"archive":l.actions.archive.init(e);break;case"delete":l.actions.delete.init(e);break;case"record_event":l.actions.recordEvent.init(e)}},subscribe:{init:function(e){for(var i,n=["tags","groups","mergeFields"],o=0;o<n.length;o++)if(i=l.Cache.get(l.provider,n[o]),_.isEmpty(i)||!_.has(i,e.list_id))return void this.request(e);this.render(e)},request:function(i){var n=this;l.Providers.ajax.request(l.provider,{data:{task:"objects_get",list_id:i.list_id,account_id:i.account_id,connection_id:i.connection_id,sources:{tags:!0,groups:!0,mergeFields:!0}}}).done(function(e){!e.success||_.isEmpty(e.data)?l.helpers.showErrorMsg(e.data):(n.cache(e.data,i),n.render(i))})},render:function(e){var i=l.helpers.getFieldsForMapping(wpf.getFields()),n=l.Cache.getById(l.provider,"mergeFields",e.list_id),o=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-subscribe"),r=l.Cache.getById(l.provider,"connections",e.connection_id),t=l.connection.getById(e.connection_id),c=!1,r=r.account_id!==e.account_id?{id:r.id}:l.connection.filterFieldsMeta(r,n),o=(t.find(".wpforms-builder-mailchimp-provider-actions-data").html(o({connection:r,tags:l.Cache.getById(l.provider,"tags",e.list_id),groups:l.Cache.getById(l.provider,"groups",e.list_id),provider:l.provider})+l.tmpl.callbacks.optionalFieldsHTML(e,i,n)),_.isObject(n)&&_.isEmpty(n.optional)&&(c=!0,t.find(".wpforms-builder-provider-connection-fields-table tbody").html("")),l.tmpl.callbacks.requiredFieldsHTML(r,i,n));_.isEmpty(o)?c&&t.find(".wpforms-builder-provider-connection-fields").remove():t.find(".wpforms-builder-provider-connection-fields-table tbody").prepend(o),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])},cache:function(i,n){_.each(["tags","groups","mergeFields"],function(e){_.isUndefined(l.Cache.get(l.provider,e))&&l.Cache.set(l.provider,e,{}),_.has(i,e)&&l.Cache.addTo(l.provider,e,n.list_id,i[e])})}},unsubscribe:{init:function(e){this.render(e)},render:function(e){var i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-unsubscribe");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(i()),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}},archive:{init:function(e){this.render(e)},render:function(e){var i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-archive");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(i()),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}},delete:{init:function(e){this.render(e)},render:function(e){var i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-delete");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(i()),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}},recordEvent:{init:function(e){this.render(e)},render:function(e){var i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-record-event");l.connection.getById(e.connection_id).find(".wpforms-builder-mailchimp-provider-actions-data").html(i({connection:l.Cache.getById(l.provider,"connections",e.connection_id),provider:l.provider})),d.$providerConnections.trigger("connectionRendered",[l.provider,e.connection_id])}}},tmpl:{callbacks:{commonsHTML:function(){var e=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-error"),i=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-lock");return e()+i({provider:l.provider})},optionalFieldsHTML:function(e,i,n){var o=l.Templates.get("wpforms-providers-builder-content-connection-fields"),r=l.Cache.getById(l.provider,"connections",e.connection_id);return _.isObject(n)&&_.has(n,"optional")?o({connection:r=r.account_id!==e.account_id?{id:r.id}:r,fields:i,provider:{slug:l.provider,placeholder:wpformsMailchimpBuilderVars.i18n.providerPlaceholder,fields:n.optional}}):""},requiredFieldsHTML:function(e,i,n){var o=l.Templates.get("wpforms-"+l.provider+"-builder-content-connection-required-fields");return _.isObject(n)&&_.has(n,"required")&&!_.isEmpty(n.required)?o({connection:e,fields:i,provider:{slug:l.provider,fields:n.required}}):""}}},helpers:{getFieldsForMapping:function(t){return _.each(t,function(n,e){var o,r;!_.isEmpty(n)&&_.has(n,"id")&&(n.id=n.id.toString(),l.helpers.isNameField(n))&&(o=l.helpers.getFieldLabel(n),delete t[e],_.each(wpformsMailchimpBuilderVars.i18n.nameFieldFormats,function(e,i){(_.has(n,"format")&&-1!==n.format.indexOf(i)||"full"===i)&&(r=n.id+"."+i,t[r]={id:r,label:o+" ("+e+")",format:n.format})}))}),t},getFieldLabel:function(e){var i="";return i=_.has(e,"id")&&_.has(e,"label")?""!==e.label.toString().trim()?wpf.sanitizeHTML(e.label.toString().trim()):wpforms_builder.field+" #"+e.id:i},getNameFormats:function(e){var i=[];return!_.has(e,"format")||_.isEmpty(e.format)||(i=e.format.split("-"),_.isArray(i))?i:[]},isNameField:function(e){return!_.isEmpty(e)&&_.has(e,"type")&&"name"===e.type},updateMapSelects:function(o,e){_.each(e,function(e){var i,n;l.helpers.isNameField(e)&&(i=(n=l.helpers.getNameFormats(e)).length,1<n.length&&i++,n=s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-fields-table-row:first option[value^="'+e.id+'."]',o.first()),i&&i===n.length?l.helpers.updateOptionsLabel(s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value^="'+e.id+'."]',o),l.helpers.getFieldLabel(e)):(n.length||(n=s(".wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-fields-table-row:first .wpforms-builder-provider-connection-field-value option",o.first())),l.helpers.updateNameFieldOptions(o,n,e)))})},updateNameFieldOptions:function(r,t,c){var d=l.helpers.getFieldLabel(c),a=c.id;t.filter('[value="'+a+'"]').length||(a=t.last().val()),_.each(wpformsMailchimpBuilderVars.i18n.nameFieldFormats,function(e,i){var n=c.id+"."+i,o=t.filter('[value="'+n+'"]');-1===c.format.indexOf(i)&&"full"!==i?o.length&&s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+n+'"]',r).remove():o.length?(a=n,l.helpers.updateOptionsLabel(o,d)):(s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+a+'"]',r).after(s("<option>",{text:wpf.sanitizeHTML(d+" ("+e+")"),value:n})),a=n)}),s('.wpforms-builder-provider-connection-fields-table .wpforms-builder-provider-connection-field-value option[value="'+c.id+'"]',r).remove()},updateOptionsLabel:function(e,r){_.each(e,function(e){var e=s(e),i=e.val(),n=e.text(),i=i.split("."),o=r;!_.isArray(i)||i.length<2||(i=i[1],_.has(wpformsMailchimpBuilderVars.i18n.nameFieldFormats,i)&&(o+=" ("+wpformsMailchimpBuilderVars.i18n.nameFieldFormats[i]+")"),n!==o&&e.text(o))})},maybeSaveFormState:function(){var e=wpf.getFormState("#wpforms-builder-form");wpf.savedState!==e&&(wpf.savedState=e)},showErrorMsg:function(e){e=_.isEmpty(e.error)?wpformsMailchimpBuilderVars.i18n.generalAjaxError:e.error;d.$lock.val(1),d.$error.html(wpf.sanitizeHTML(e)).show()}}};return l}(document,window,jQuery),WPForms.Admin.Builder.Providers.Mailchimp.init();